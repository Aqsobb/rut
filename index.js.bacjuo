// index.js
const TelegramBot = require('node-telegram-bot-api');
const { TOKEN, OWNER_ID, BOT_NAME, OWNER_NAMA, OWNER_NOMOR_HP } = require('./config');

// Pastikan database.js lu export load_db & save_db
const { get_user_data, register_user, load_db, save_db, kurangi_limit, add_premium } = require('./database');
const { kirim_email_sakti, hapus_pesan_terkirim, cek_dan_hapus_balasan } = require('./email_service');
const { startUserSession, process_bulk_wa, initAutoResume, checkSessionStatus } = require('./wa_service');
const MSG = require('./utils/messages');

// --- SETTINGAN BOT STABIL (POLLING 300ms) ---
const bot = new TelegramBot(TOKEN, { 
    polling: {
        interval: 300,
        autoStart: true,
        params: { timeout: 10 }
    } 
});

const userStates = {};
const SAFE_OWNER_ID = String(OWNER_ID).trim();

// ANTI CRASH (PENTING BIAR GAK MATI KONYOL)
process.on('uncaughtException', (err) => console.log('âš ï¸ Error (Ignored):', err.message));
process.on('unhandledRejection', (err) => console.log('âš ï¸ Promise Error (Ignored):', err.message));

// Auto Resume Sesi WA
initAutoResume();

// SET COMMAND TELEGRAM
const setMenu = async () => {
    try {
        await bot.setMyCommands([
            { command: 'start', description: 'ðŸ¤– Menu Utama' },
            { command: 'fix', description: 'ðŸ’‰ Fix Nomor' },
            { command: 'cekwa', description: 'ðŸ” Cek Bio Massal' },
            { command: 'pair', description: 'ðŸ”— Sambungin WA' },
            { command: 'profile', description: 'ðŸ‘¤ Profil' },
            { command: 'owner', description: 'ðŸ“ž Owner' }
        ]);
        console.log("âœ… Menu Updated!");
    } catch (e) {}
};
setMenu();

// --- MESSAGE HANDLER ---
bot.on('message', async (msg) => {
    try {
        const chatId = msg.chat.id;
        const text = msg.text;
        const userId = String(msg.from.id);

        if (!text || text.startsWith('/')) return;

        // CEK STATE (PROSES YANG SEDANG BERJALAN)
        if (userStates[chatId]) {
            const state = userStates[chatId];

            // 1. SETUP EMAIL
            if (state.step === 'ASK_EMAIL') {
                state.data.email = text;
                state.step = 'ASK_PASS';
                await bot.sendMessage(chatId, MSG.setup_pass, { parse_mode: 'Markdown' });
                return;
            } else if (state.step === 'ASK_PASS') {
                state.data.pass = text.replace(/\s/g, '');
                state.step = 'ASK_NAME';
                await bot.sendMessage(chatId, MSG.setup_name, { parse_mode: 'Markdown' });
                return;
            } else if (state.step === 'ASK_NAME') {
                register_user(userId, state.data.email, state.data.pass, text);
                delete userStates[chatId];
                await sendMainMenu(chatId, userId, MSG.setup_done);
                return;
            }
            
// --- FIX NOMOR (LOGIC FIX "BISU") ---
            else if (state.step === 'ASK_FIX_NUMBER') {
                delete userStates[chatId];
                const nomor = text;
                const data = get_user_data(userId);
                
                const sentMsg = await bot.sendMessage(chatId, MSG.email_sending, { parse_mode: 'Markdown' });
                console.log(`ðŸš€ Memulai proses fix untuk ${nomor}...`);
                
                // 1. KIRIM EMAIL
                const result = await kirim_email_sakti(data.email, data.password, data.nama, nomor);

                if (result.success) {
                    await bot.editMessageText(MSG.email_sent, { 
                        chat_id: chatId, 
                        message_id: sentMsg.message_id, 
                        parse_mode: 'Markdown' 
                    }).catch(() => {}); // Catch error kalo gagal edit (ignore)

                    // 2. HAPUS SENT (Background)
                    console.log("ðŸ§¹ Membersihkan folder Terkirim...");
                    hapus_pesan_terkirim(data.email, data.password);

                    // 3. PANTAU BALASAN
                    console.log("ðŸ‘€ Menunggu balasan WhatsApp (Max 5 Menit)...");
                    let replyFound = false;
                    for (let i = 0; i < 150; i++) { // 5 Menit
                        await new Promise(r => setTimeout(r, 2000));
                        
                        const check = await cek_dan_hapus_balasan(data.email, data.password);
                        if (check) { 
                            replyFound = true; 
                            console.log("âœ… SUKSES! Balasan ditemukan dan dihapus.");
                            break; 
                        }
                    }
                    
                    kurangi_limit(userId);
                    
                    // --- BAGIAN INI YANG GW FIX BIAR GAK BISU ---
                    if (replyFound) {
                        try {
                            // Coba edit pesan lama
                            await bot.editMessageText(MSG.fix_success(nomor), { 
                                chat_id: chatId, 
                                message_id: sentMsg.message_id, 
                                parse_mode: 'Markdown' 
                            });
                        } catch (e) {
                            // KALAU GAGAL EDIT, KIRIM PESAN BARU (FORCE NOTIFY)
                            await bot.sendMessage(chatId, MSG.fix_success(nomor), { parse_mode: 'Markdown' });
                        }
                    } else {
                        try {
                            await bot.editMessageText(MSG.fix_no_reply, { 
                                chat_id: chatId, 
                                message_id: sentMsg.message_id, 
                                parse_mode: 'Markdown' 
                            });
                        } catch (e) {
                            await bot.sendMessage(chatId, MSG.fix_no_reply, { parse_mode: 'Markdown' });
                        }
                    }

                } else {
                    await bot.editMessageText(MSG.fix_failed(result.error), { 
                        chat_id: chatId, 
                        message_id: sentMsg.message_id 
                    });
                }
                return;
            }

            // 3. CEK WA
            else if (state.step === 'ASK_WA_TARGET') {
                delete userStates[chatId];
                const sentMsg = await bot.sendMessage(chatId, MSG.wa_connecting, { parse_mode: 'Markdown' });
                const hasil = await process_bulk_wa(userId, text);
                await bot.editMessageText(hasil || "âŒ Error: Hasil kosong.", { chat_id: chatId, message_id: sentMsg.message_id, parse_mode: 'Markdown' });
                return;
            }

            // 4. PAIRING
            else if (state.step === 'ASK_PAIRING_NUMBER') {
                delete userStates[chatId];
                const cleanNum = text.replace(/[^0-9]/g, '');
                const waitMsg = await bot.sendMessage(chatId, "â³ *Meminta Kode...*", { parse_mode: 'Markdown' });

                startUserSession(userId, cleanNum, async (response, error) => {
                    if (response === "CONNECTED") {
                        try {
                            await bot.sendMessage(chatId, "âœ… *SUKSES TERHUBUNG!*", { parse_mode: 'Markdown' });
                            await sendMainMenu(chatId, userId);
                        } catch(e) {}
                    } else if (response === "REGISTERED") {
                        bot.editMessageText("âš ï¸ *Udah Konek Cuk!*", { chat_id: chatId, message_id: waitMsg.message_id, parse_mode: 'Markdown' });
                    } else if (response) {
                        bot.editMessageText(MSG.pairing_code(response), { chat_id: chatId, message_id: waitMsg.message_id, parse_mode: 'Markdown' });
                    } else {
                        bot.editMessageText(`âŒ Gagal: ${error || "Unknown Error"}`, { chat_id: chatId, message_id: waitMsg.message_id });
                    }
                });
                return;
            }
        }

        // HANDLER TEXT MENU (BUTTON BAWAH)
        if (text === 'ðŸ’‰ FIX NOMOR') { start_fix(msg); return; }
        if (text === 'ðŸ” CEK WA') { start_cek_wa(msg); return; }
        if (text === 'ðŸ”— KONEKSI WA') { start_pairing(msg); return; }
        if (text === 'â™»ï¸ SETUP EMAIL') { start_setup(msg); return; }
        if (text === 'ðŸ‘¤ PROFIL') { show_profile(msg); return; }
        if (text === 'ðŸ“ž OWNER') { send_vcard(msg); return; }

    } catch (e) { console.log("Msg Error:", e.message); }
});

// --- COMMAND HANDLERS ---
bot.onText(/\/start/, (msg) => sendMainMenu(msg.chat.id, String(msg.from.id)));
bot.onText(/\/pair/, (msg) => start_pairing(msg));
bot.onText(/\/fix/, (msg) => start_fix(msg));
bot.onText(/\/cekwa/, (msg) => start_cek_wa(msg));
bot.onText(/\/owner/, (msg) => send_vcard(msg));
bot.onText(/\/profile/, (msg) => show_profile(msg));
bot.onText(/\/myid/, (msg) => bot.sendMessage(msg.chat.id, `ID: \`${msg.from.id}\``, {parse_mode: 'Markdown'}));

// ===================================
// ðŸ”¥ FITUR KHUSUS OWNER (MANUAL)
// ===================================

// 1. ADD PREMIUM (SMART CHECK)
bot.onText(/\/addprem(.*)/, (msg, match) => {
    if (String(msg.from.id) !== SAFE_OWNER_ID) return;
    
    // Pecah input jadi array. Contoh: "12345 30" -> ["12345", "30"]
    const args = match[1].trim().split(' ').filter(i => i);
    
    // Kalau argumen kurang dari 2 (Gak ada ID atau Hari), kirim panduan
    if (args.length < 2) {
        return bot.sendMessage(msg.chat.id, MSG.owner_guide_addprem, { parse_mode: 'Markdown' });
    }

    const targetId = args[0];
    const days = args[1];
    const expiry = add_premium(targetId, days);
    
    bot.sendMessage(msg.chat.id, MSG.owner_success_prem(targetId, days, expiry), { parse_mode: 'Markdown' });
});

// 2. ADD LIMIT (SMART CHECK)
bot.onText(/\/addlimit(.*)/, (msg, match) => {
    if (String(msg.from.id) !== SAFE_OWNER_ID) return;
    
    const args = match[1].trim().split(' ').filter(i => i);
    
    if (args.length < 2) {
        return bot.sendMessage(msg.chat.id, MSG.owner_guide_addlimit, { parse_mode: 'Markdown' });
    }

    const targetId = args[0];
    const amount = parseInt(args[1]);
    const db = load_db();
    
    if (db[targetId]) {
        const oldLimit = db[targetId].limit || 0;
        db[targetId].limit = oldLimit + amount;
        save_db(db);
        bot.sendMessage(msg.chat.id, MSG.owner_success_limit(targetId, amount, db[targetId].limit), { parse_mode: 'Markdown' });
    } else {
        bot.sendMessage(msg.chat.id, MSG.owner_user_not_found);
    }
});

// 3. UNPREM (SMART CHECK)
bot.onText(/\/unprem(.*)/, (msg, match) => {
    if (String(msg.from.id) !== SAFE_OWNER_ID) return;
    
    const args = match[1].trim().split(' ').filter(i => i);
    
    if (args.length < 1) {
        return bot.sendMessage(msg.chat.id, MSG.owner_guide_unprem, { parse_mode: 'Markdown' });
    }

    const targetId = args[0];
    const db = load_db();
    
    if (db[targetId]) {
        db[targetId].role = 'free';
        db[targetId].limit = 0; 
        db[targetId].expired = null;
        save_db(db);
        bot.sendMessage(msg.chat.id, MSG.owner_success_unprem(targetId), { parse_mode: 'Markdown' });
    } else {
        bot.sendMessage(msg.chat.id, MSG.owner_user_not_found);
    }
});


// --- CALLBACK QUERY ---
bot.on('callback_query', (query) => {
    const msg = query.message;
    msg.from = query.from;
    bot.answerCallbackQuery(query.id).catch(()=>{});

    const data = query.data;
    if (data === 'menu_fix') start_fix(msg);
    else if (data === 'menu_cek_wa') start_cek_wa(msg);
    else if (data === 'menu_pairing') start_pairing(msg);
    else if (data === 'menu_setup') start_setup(msg);
    else if (data === 'menu_profile') show_profile(msg);
    else if (data === 'menu_owner') send_vcard(msg);
    
    // HANDLER TOMBOL OWNER MENU
    else if (data === 'menu_owner_panel') {
        if (String(query.from.id) !== SAFE_OWNER_ID) return bot.sendMessage(msg.chat.id, "âŒ Lu bukan owner cuk!");
        const helpText = 
            "ðŸ‘‘ *OWNER COMMANDS*\n\n" +
            "âž• *Premium:* `/addprem ID HARI`\n" +
            "âž• *Limit:* `/addlimit ID JUMLAH`\n" +
            "âŒ *Unprem:* `/unprem ID`\n" +
            "ðŸ†” *Cek ID:* `/myid`";
        bot.sendMessage(msg.chat.id, helpText, { parse_mode: 'Markdown' });
    }
});

// ===================================
// ðŸ”¥ HELPER UTAMA (RESET LIMIT LOGIC)
// ===================================

const sendMainMenu = async (chatId, userId, extraText = "") => {
    const isOwner = String(userId) === SAFE_OWNER_ID;
    
    // LOAD DB LATEST BIAR DATA UPDATE
    const db = load_db();
    let data = db[userId];
    
    // --- LOGIKA CEK EXPIRED & RESET LIMIT ---
    if (data && data.role === 'premium' && data.expired) {
        const today = new Date().toISOString().split('T')[0]; // Format YYYY-MM-DD
        if (today > data.expired) {
            // Expired! Reset jadi Free & Limit 3
            data.role = 'free';
            data.limit = 3; // RESET JADI 3
            data.expired = null;
            save_db(db); // Simpan perubahan
            extraText += "\nâš ï¸ *Masa Premium habis!* Limit direset ke 3.";
        }
    }
    // ----------------------------------------

    let roleDisp = "âŒ BELUM TERDAFTAR";
    let limitDisp = "0";
    let expiryDisp = "";
    let waStatus = checkSessionStatus(userId);
    const isWAConnected = waStatus.includes("Aktif");

    if (isOwner) { roleDisp = "ðŸ‘‘ OWNER"; limitDisp = "UNLIMITED"; }
    else if (data && data.role === 'premium') { roleDisp = "ðŸŒŸ PREMIUM"; limitDisp = "UNLIMITED"; expiryDisp = data.expired || "Lifetime"; }
    else if (data) { roleDisp = "ðŸ‘¤ FREE"; limitDisp = `${data.limit}x`; }

    const textBase = MSG.menu_text ? MSG.menu_text(userId, roleDisp, limitDisp, expiryDisp, waStatus) : "Menu Error";
    const textFull = extraText ? `${extraText}\n${textBase}` : textBase;

    const inlineKeyboard = [];
    const userReady = (data && data.email) || isOwner;

    if (userReady) {
        inlineKeyboard.push([{ text: "ðŸ’‰ FIX NOMOR (STEALTH)", callback_data: 'menu_fix' }]);
        inlineKeyboard.push([{ text: "ðŸ” CEK WA (BIO/REG)", callback_data: 'menu_cek_wa' }]);
        inlineKeyboard.push([{ text: "ðŸ‘¤ CEK PROFIL", callback_data: 'menu_profile' }]);
        inlineKeyboard.push([{ text: "â™»ï¸ Setup Ulang", callback_data: 'menu_setup' }]);
    } else {
        inlineKeyboard.push([{ text: "ðŸ” SETUP AKUN (WAJIB)", callback_data: 'menu_setup' }]);
    }
    
    if ((isOwner || (data && data.role === 'premium')) && !isWAConnected) {
        inlineKeyboard.push([{ text: "ðŸ”— KONEKSI WA (PAIRING)", callback_data: 'menu_pairing' }]);
    }
    
    // TOMBOL KHUSUS OWNER
    if (isOwner) {
        inlineKeyboard.push([{ text: "ðŸ‘‘ OWNER MENU", callback_data: 'menu_owner_panel' }]);
    } else {
        inlineKeyboard.push([{ text: "ðŸ“ž CONTACT OWNER", callback_data: 'menu_owner' }]);
    }

    const replyKeyboard = {
        keyboard: [["ðŸ’‰ FIX NOMOR", "ðŸ” CEK WA"], ["ðŸ‘¤ PROFIL", "â™»ï¸ SETUP EMAIL"], ["ðŸ“ž OWNER"]],
        resize_keyboard: true
    };
    if ((isOwner || (data && data.role === 'premium')) && !isWAConnected) {
        replyKeyboard.keyboard.push(["ðŸ”— KONEKSI WA"]);
    }

    await bot.sendMessage(chatId, textFull, { parse_mode: 'Markdown', reply_markup: { inline_keyboard: inlineKeyboard } });
    await bot.sendMessage(chatId, MSG.menu_keyboard_text, { parse_mode: 'Markdown', reply_markup: replyKeyboard });
};

// --- START FUNCTIONS ---
const start_pairing = (msg) => {
    const chatId = msg.chat.id;
    const userId = String(msg.from.id);
    const data = get_user_data(userId);
    const isOwner = userId === SAFE_OWNER_ID;
    if (checkSessionStatus(userId).includes("Aktif")) return bot.sendMessage(chatId, "âš ï¸ WhatsApp lu udah konek cuk!");
    if (!isOwner && (!data || data.role !== 'premium')) return bot.sendMessage(chatId, "âŒ Fitur Koneksi WA cuma buat user PREMIUM cuk!", { parse_mode: 'Markdown' });
    userStates[chatId] = { step: 'ASK_PAIRING_NUMBER' };
    bot.sendMessage(chatId, MSG.pairing_intro, { parse_mode: 'Markdown' });
};
const start_cek_wa = (msg) => {
    const chatId = msg.chat.id;
    const userId = String(msg.from.id);
    const data = get_user_data(userId);
    const isOwner = userId === SAFE_OWNER_ID;
    const isPremium = data && data.role === 'premium';
    if (!isOwner && !isPremium) {
        const insult = MSG.insults[Math.floor(Math.random() * MSG.insults.length)];
        return bot.sendMessage(chatId, insult, { parse_mode: 'Markdown' });
    }
    userStates[chatId] = { step: 'ASK_WA_TARGET' };
    bot.sendMessage(chatId, MSG.cek_wa_intro, { parse_mode: 'Markdown' });
};
const start_fix = (msg) => {
    const chatId = msg.chat.id;
    const userId = String(msg.from.id);
    const data = get_user_data(userId);
    const isOwner = userId === SAFE_OWNER_ID;
    if (isOwner && (!data || !data.email)) return bot.sendMessage(chatId, MSG.owner_setup_alert, {parse_mode:'Markdown'});
    if (!data || !data.email) return bot.sendMessage(chatId, MSG.no_setup);
    if (!isOwner && data.role !== 'premium' && data.limit <= 0) return bot.sendMessage(chatId, MSG.limit_reached, {parse_mode:'Markdown'});
    userStates[chatId] = { step: 'ASK_FIX_NUMBER' };
    bot.sendMessage(chatId, MSG.fix_intro, { parse_mode: 'Markdown' });
};
const start_setup = (msg) => {
    const chatId = msg.chat.id;
    userStates[chatId] = { step: 'ASK_EMAIL', data: {} };
    bot.sendMessage(chatId, MSG.setup_intro, { parse_mode: 'Markdown' });
};
const show_profile = (msg) => sendMainMenu(msg.chat.id, String(msg.from.id));
const send_vcard = (msg) => bot.sendContact(msg.chat.id, OWNER_NOMOR_HP, OWNER_NAMA);

console.log("ðŸ¤– BOT STARTED...");